"use strict";(()=>{function _(e){return!e||!e.startsWith(__$ampere.config.prefix)?e:__$ampere.config.codec.decode(e.slice(__$ampere.config.prefix.length))}var T=["getAttribute","setAttribute","hasAttribute","removeAttribute","getAttributeNode","setAttributeNode","removeAttributeNode","getAttributeNames"],A={href:[HTMLAnchorElement,HTMLLinkElement,HTMLAreaElement,HTMLBaseElement],src:[HTMLAudioElement,HTMLEmbedElement,HTMLIFrameElement,HTMLImageElement,HTMLInputElement,HTMLScriptElement,HTMLSourceElement,HTMLTrackElement,HTMLVideoElement],srcdoc:[HTMLIFrameElement],srcset:[HTMLImageElement,HTMLSourceElement],action:[HTMLFormElement],poster:[HTMLVideoElement],formaction:[HTMLButtonElement],data:[HTMLObjectElement],background:[HTMLBodyElement],integrity:[HTMLScriptElement,HTMLLinkElement],nonce:[HTMLElement]},o=Object.fromEntries(T.map(e=>[e,Object.getOwnPropertyDescriptor(Element.prototype,e)?.value])),m=Object.getOwnPropertyDescriptor(Element.prototype,"innerHTML"),g=Object.getOwnPropertyDescriptor(Element.prototype,"innerText");Object.defineProperties(Element.prototype,{innerHTML:{set(e){return this instanceof HTMLScriptElement?m?.set?.call(this,__$ampere.rewriteJS(e,__$ampere.base)):this instanceof HTMLStyleElement?m?.set?.call(this,__$ampere.rewriteCSS(e,__$ampere.base)):m?.set?.call(this,__$ampere.rewriteHTML(e,__$ampere.base)),e},get(){return m?.get?.call(this)}},innerText:{set:function(e){return this instanceof HTMLScriptElement?g?.set?.call(this,__$ampere.rewriteJS(e,__$ampere.base)):this instanceof HTMLStyleElement?g?.set?.call(this,__$ampere.rewriteCSS(e,__$ampere.base)):g?.set?.call(this,e),e},get:function(){return g?.get?.call(this)}},getAttribute:{value:function(e){return/^_/.test(e)?o.getAttribute.call(this,`_${e}`):o.hasAttribute.call(this,`_${e}`)?o.getAttribute.call(this,`_${e}`):o.getAttribute.call(this,e)}},setAttribute:{value:function(e,t){return e.startsWith("on")?o.setAttribute.call(this,e,__$ampere.rewriteJS(t,__$ampere.base)):/^_/.test(e)?o.setAttribute.call(this,`_${e}`,t):o.setAttribute.call(this,e,t)}},hasAttribute:{value:function(e){return/^_/.test(e)?o.hasAttribute.call(this,`_${e}`):o.hasAttribute.call(this,`_${e}`)?!0:o.hasAttribute.call(this,e)}},removeAttribute:{value:function(e){return/^_/.test(e)?o.removeAttribute.call(this,`_${e}`):o.hasAttribute.call(this,`_${e}`)?o.removeAttribute.call(this,`_${e}`):o.removeAttribute.call(this,e)}},getAttributeNode:{value:function(e){if(/^_/.test(e))return o.getAttributeNode.call(this,`_${e}`);if(o.hasAttribute.call(this,`_${e}`)){let t=o.getAttributeNode.call(this,`_${e}`);return t?new Proxy(t,{get:function(r,n){return["name","localName","nodeName"].includes(n)?r.name.replace(/^_/,""):r[n]}}):null}return o.getAttributeNode.call(this,e)}},setAttributeNode:{value:function(e){return/^on[a-z]+/i.test(e.name)?o.setAttribute.call(this,e.name,__$ampere.rewriteJS(e.value,__$ampere.base)):/^_/.test(e.name)?o.setAttribute.call(this,`_${e}`,e.value):o.setAttributeNode.call(this,e)}},removeAttributeNode:{value:function(e){return/^_/.test(e.name)?o.removeAttribute.call(this,`_${e.name}`):o.hasAttribute.call(this,`_${e.name}`)?(o.removeAttribute.call(this,e.name),o.removeAttribute.call(this,`_${e.name}`)):o.removeAttributeNode.call(this,e)}},getAttributeNames:{value:function(){let e=o.getAttributeNames.call(this);return e=e.map(t=>/^_/.test(t)?t.replace(/^_/,""):t),Array.from(new Set(e))}}});Object.entries(A).forEach(([e,t])=>{t.forEach(r=>{let{get:n,set:s}=Object.getOwnPropertyDescriptor(r.prototype,e)??{};!n||!s||Object.defineProperty(r.prototype,e,{get(){return e==="href"||e==="src"?_(this.getAttribute(e)):n.call(this)},set(i){return e==="href"||e==="src"?this.setAttribute(e,__$ampere.rewriteURL(i,__$ampere.base)):e==="integrity"?o.setAttribute.call(this,`_${e}`,i):e==="srcdoc"&&(o.setAttribute.call(this,"srcdoc",__$ampere.rewriteHTML(i,__$ampere.base)),o.setAttribute.call(this,`_${e}`,i)),s.call(this,i),i}})})});function w(e){return new Proxy(e,{apply(t,r,n){return __$ampere.logger.debug("Hooking history update",n[2]),n[2]&&(n[2]=__$ampere.rewriteURL(n[2],__$ampere.base)),Reflect.apply(t,r,n)}})}history.pushState=w(history.pushState);history.replaceState=w(history.replaceState);Object.defineProperty(navigator,"serviceWorker",{get(){}});Object.defineProperty(Navigator.prototype,"serviceWorker",{get(){}});window.fetch=new Proxy(fetch,{apply(e,t,r){return __$ampere.logger.debug("Hooking fetch",r[0]),r[0]&&typeof r[0]=="string"&&(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base)),Reflect.apply(e,t,r)}});navigator.sendBeacon=new Proxy(navigator.sendBeacon,{apply(e,t,r){return __$ampere.logger.debug("Hooking sendBeacon",r[0]),r[0]&&(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base)),Reflect.apply(e,t,r)}});window.XMLHttpRequest.prototype.open=new Proxy(window.XMLHttpRequest.prototype.open,{apply(e,t,r){return __$ampere.logger.debug("Hooking XHR.open",r[1]),r[1]&&(r[1]=__$ampere.rewriteURL(r[1].toString(),__$ampere.base)),Reflect.apply(e,t,r)}});window.WebSocket=new Proxy(window.WebSocket,{construct(e,t){let r=new e(`${location.protocol.replace("http","ws")}//${new URL(__$ampere.bare).host}/v3/`),n=0,s=Object.getOwnPropertyDescriptor(WebSocket.prototype,"readyState")?.get;Object.defineProperty(r,"readyState",{get(){return n===0?0:s?.call(r)}});function i(u){u.preventDefault(),u.stopImmediatePropagation();let p=JSON.parse(u.data);p.type==="open"?(p.setCookies.forEach($=>{__$ampere.scope(document).cookie=$}),Object.defineProperties(r,{protocol:{value:p.protocol},url:{value:t[0]}}),n=1,r.dispatchEvent(new Event("open"))):r.close()}r.addEventListener("message",i,{once:!0});function c(u){u.preventDefault(),u.stopImmediatePropagation(),r.send(JSON.stringify({type:"connect",remote:t[0],protocols:t[1]?[t[1]].flat():[],headers:{"Cache-Control":"no-cache",Connection:"Upgrade",Host:new URL(t[0]).host,Origin:__$ampere.scope(location).origin,Pragma:"no-cache",Upgrade:"websocket","User-Agent":navigator.userAgent,Cookie:__$ampere.scope(document).cookie},forwardHeaders:[]}))}return r.addEventListener("open",c,{once:!0}),r}});window.Request=new Proxy(Request,{construct(e,t){return __$ampere.logger.debug("Hooking Request constructor",t[0]),t[0]&&typeof t[0]=="string"&&(t[0]=__$ampere.rewriteURL(t[0],__$ampere.base)),new Proxy(Reflect.construct(e,t),{get(r,n){return n==="url"?__$ampere.unwriteURL(r[n]):Reflect.get(r,n)}})}});window.Response=new Proxy(Response,{construct(e,t){return new Proxy(Reflect.construct(e,t),{get(r,n){return n==="url"?__$ampere.unwriteURL(r[n]):Reflect.get(r,n)}})}});for(let e of __$ampere.config.plugins)try{e.client&&(__$ampere.logger.info("Loading plugin",e.name),e.client(window),__$ampere.logger.info("Loaded plugin",e.name))}catch(t){__$ampere.logger.error("Failed to load plugin",e.name,t)}function y(e){return Object.setPrototypeOf({length:e.length,item(t){if(t!==void 0)return e[t]??null;throw new TypeError("Failed to execute 'item' on 'DOMStringList': 1 argument required, but only 0 present.")},contains(t){if(t!==void 0)return e.includes(t);throw new TypeError("Failed to execute 'contains' on 'DOMStringList': 1 argument required, but only 0 present.")}},DOMStringList.prototype)}var d=new Map;function a(e){let t=d.get(e);return Object.values(d).includes(e)?e:(t||(t=new Proxy(Object.setPrototypeOf({},Location.prototype),{get(r,n){let s=new URL(e.href);if(e.href==="about:srcdoc"||e.href==="about:blank"?s=new URL(__$ampere.unwriteURL(parent.location.pathname)):e.pathname.startsWith(__$ampere.config.prefix)&&(s=new URL(__$ampere.unwriteURL(e.pathname))),n==="constructor")return e.constructor;if(n===Symbol.toStringTag)return"Location";if(n==="assign")return i=>{e.assign(__$ampere.rewriteURL(i,__$ampere.scope(e)))};if(n==="reload")return()=>{e.reload()};if(n==="replace")return i=>{e.replace(__$ampere.rewriteURL(i,__$ampere.scope(e)))};if(n==="toString")return()=>__$ampere.scope(e).href;if(n==="ancestorOrigins")return y([]);if(typeof s[n]<"u")return s[n]},ownKeys(){return Object.keys(e)},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},set(r,n,s){let i=new URL(__$ampere.unwriteURL(e.pathname));return i[n]?(i[n]=s,e.href=__$ampere.rewriteURL(i.toString(),__$ampere.scope(e)),!0):!1}}),d.set(e,t)),t)}var h=new Map;function f(e){let t=h.get(e);return Object.values(h).includes(e)?e:(t||(t=new Proxy(e,{get(r,n,s){switch(n){case"location":return a(e.location);case"documentURI":return a(e.location).toString();case"baseURI":return __$ampere.base;case"cookie":return"";case"referrer":try{return _(new URL(e.referrer).pathname)}catch{return""}case"URL":return a(e.location).toString();case"domain":return a(e.location).hostname;case"write":return(...c)=>{e.write(__$ampere.rewriteHTML(c.join(""),__$ampere.base))};case"writeln":return(...c)=>{e.write(__$ampere.rewriteHTML(c.join(""),__$ampere.base))};case"open":return(...c)=>{f(e.open(...c))};default:let i=e[n];return typeof i=="function"&&i.toString==self.Object.toString?new Proxy(i,{apply(c,u,p){return Reflect.apply(c,e,p)}}):i}},set(r,n,s,i){return n==="cookie"?!0:e[n]=s}}),h.set(e,t)),t)}var b=new Map;function l(e){let t=b.get(e);return Object.values(b).includes(e)?e:(t||(t=new Proxy(e,{get(r,n,s){switch(n){case"location":return a(e.location);case"window":return l(e.window);case"document":return f(e.document);case"self":return l(e.self);case"top":return l(e.top??e.parent);case"parent":return l(e.parent);case"opener":return l(e.opener);case"globalThis":return l(e.globalThis);default:let i=e[n];return typeof i=="function"&&i.toString==self.Object.toString?new Proxy(i,{apply(c,u,p){return Reflect.apply(c,e,p)}}):i}},set(r,n,s,i){return e[n]=s,!0}}),b.set(e,t)),t)}function L(e){if(!e)return e;e.constructor;let t=e[Symbol.toStringTag],r=typeof e=="function"?e.name:void 0;if(!new RegExp(`^function ${t||r}\\(\\)\\s+\\{\\s+\\[native code\\]\\s+\\}$`).test(e.constructor.toString()))return e;switch(t||r){case"Window":return l(e);case"Location":return a(e);case"History":break;case"Storage":break;case"HTMLDocument":return f(e);case"postMessage":break;case"eval":break}return e}Object.defineProperty(Object.prototype,"__$ampere",{value:Object.assign(globalThis.__$ampere||{},{scope:L}),configurable:!1,enumerable:!1});})();
