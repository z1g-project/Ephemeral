"use strict";(()=>{var E=["getAttribute","setAttribute","hasAttribute","removeAttribute","getAttributeNode","setAttributeNode","removeAttributeNode","getAttributeNames"],P={href:[HTMLAnchorElement,HTMLLinkElement,HTMLAreaElement,HTMLBaseElement],src:[HTMLAudioElement,HTMLEmbedElement,HTMLIFrameElement,HTMLImageElement,HTMLInputElement,HTMLScriptElement,HTMLSourceElement,HTMLTrackElement,HTMLVideoElement],srcdoc:[HTMLIFrameElement],srcset:[HTMLImageElement,HTMLSourceElement],action:[HTMLFormElement],poster:[HTMLVideoElement],formaction:[HTMLButtonElement],data:[HTMLObjectElement],background:[HTMLBodyElement],integrity:[HTMLScriptElement,HTMLLinkElement],nonce:[HTMLElement]},i=Object.fromEntries(E.map(e=>[e,Object.getOwnPropertyDescriptor(Element.prototype,e)?.value])),_=Object.getOwnPropertyDescriptor(Element.prototype,"innerHTML"),m=Object.getOwnPropertyDescriptor(Element.prototype,"innerText");Object.defineProperty(Node.prototype,"baseURI",{get(){return __$ampere.base}});Object.defineProperties(Element.prototype,{innerHTML:{set(e){return this instanceof HTMLScriptElement?_?.set?.call(this,__$ampere.rewriteJS(e,__$ampere.base)):this instanceof HTMLStyleElement?_?.set?.call(this,__$ampere.rewriteCSS(e,__$ampere.base)):_?.set?.call(this,__$ampere.rewriteHTML(e,__$ampere.base)),e},get(){return _?.get?.call(this)}},innerText:{set:function(e){return this instanceof HTMLScriptElement?m?.set?.call(this,__$ampere.rewriteJS(e,__$ampere.base)):this instanceof HTMLStyleElement?m?.set?.call(this,__$ampere.rewriteCSS(e,__$ampere.base)):m?.set?.call(this,e),e},get:function(){return m?.get?.call(this)}},getAttribute:{value:function(e){return/^_/.test(e)?i.getAttribute.call(this,`_${e}`):i.hasAttribute.call(this,`_${e}`)?i.getAttribute.call(this,`_${e}`):i.getAttribute.call(this,e)}},setAttribute:{value:function(e,r){return e.startsWith("on")?i.setAttribute.call(this,e,__$ampere.rewriteJS(r,__$ampere.base)):/^_/.test(e)?i.setAttribute.call(this,`_${e}`,r):i.setAttribute.call(this,e,r)}},hasAttribute:{value:function(e){return/^_/.test(e)?i.hasAttribute.call(this,`_${e}`):i.hasAttribute.call(this,`_${e}`)?!0:i.hasAttribute.call(this,e)}},removeAttribute:{value:function(e){return/^_/.test(e)?i.removeAttribute.call(this,`_${e}`):i.hasAttribute.call(this,`_${e}`)?i.removeAttribute.call(this,`_${e}`):i.removeAttribute.call(this,e)}},getAttributeNode:{value:function(e){if(/^_/.test(e))return i.getAttributeNode.call(this,`_${e}`);if(i.hasAttribute.call(this,`_${e}`)){let r=i.getAttributeNode.call(this,`_${e}`);return r?new Proxy(r,{get:function(t,n){return["name","localName","nodeName"].includes(n)?t.name.replace(/^_/,""):t[n]}}):null}return i.getAttributeNode.call(this,e)}},setAttributeNode:{value:function(e){return/^on[a-z]+/i.test(e.name)?i.setAttribute.call(this,e.name,__$ampere.rewriteJS(e.value,__$ampere.base)):/^_/.test(e.name)?i.setAttribute.call(this,`_${e}`,e.value):i.setAttributeNode.call(this,e)}},removeAttributeNode:{value:function(e){return/^_/.test(e.name)?i.removeAttribute.call(this,`_${e.name}`):i.hasAttribute.call(this,`_${e.name}`)?(i.removeAttribute.call(this,e.name),i.removeAttribute.call(this,`_${e.name}`)):i.removeAttributeNode.call(this,e)}},getAttributeNames:{value:function(){let e=i.getAttributeNames.call(this);return e=e.map(r=>/^_/.test(r)?r.replace(/^_/,""):r),Array.from(new Set(e))}}});Object.entries(P).forEach(([e,r])=>{r.forEach(t=>{let{get:n,set:s}=Object.getOwnPropertyDescriptor(t.prototype,e)??{};!n||!s||Object.defineProperty(t.prototype,e,{get(){return e==="href"||e==="src"?__$ampere.unwriteURL(this.getAttribute(e)):n.call(this)},set(o){return e==="href"||e==="src"?i.setAttribute.call(this,e,__$ampere.rewriteURL(o,__$ampere.base)):e==="integrity"?i.setAttribute.call(this,`_${e}`,o):e==="srcdoc"?(i.setAttribute.call(this,"srcdoc",__$ampere.rewriteHTML(o,__$ampere.base)),i.setAttribute.call(this,`_${e}`,o)):s.call(this,o),o}})})});function w(e){return new Proxy(e,{apply(r,t,n){return __$ampere.logger.debug("Hooking history update",n[2]),n[2]&&(n[2]=__$ampere.rewriteURL(n[2],__$ampere.base)),Reflect.apply(r,t,n)}})}history.pushState=w(history.pushState);history.replaceState=w(history.replaceState);Object.defineProperty(navigator,"serviceWorker",{get(){}});Object.defineProperty(Navigator.prototype,"serviceWorker",{get(){}});window.fetch=new Proxy(fetch,{apply(e,r,t){return __$ampere.logger.debug("Hooking fetch",t[0]),t[0]&&typeof t[0]=="string"&&(t[0]=__$ampere.rewriteURL(t[0],__$ampere.base)),Reflect.apply(e,r,t)}});navigator.sendBeacon=new Proxy(navigator.sendBeacon,{apply(e,r,t){return __$ampere.logger.debug("Hooking sendBeacon",t[0]),t[0]&&(t[0]=__$ampere.rewriteURL(t[0],__$ampere.base)),Reflect.apply(e,r,t)}});window.XMLHttpRequest.prototype.open=new Proxy(window.XMLHttpRequest.prototype.open,{apply(e,r,t){return __$ampere.logger.debug("Hooking XHR.open",t[1]),t[1]&&(t[1]=__$ampere.rewriteURL(t[1].toString(),__$ampere.base)),Reflect.apply(e,r,t)}});window.WebSocket=new Proxy(window.WebSocket,{construct(e,r){let t=new e(`${location.protocol.replace("http","ws")}//${new URL(__$ampere.bare).host}/v3/`),n=0,s=Object.getOwnPropertyDescriptor(WebSocket.prototype,"readyState")?.get;Object.defineProperty(t,"readyState",{get(){return n===0?0:s?.call(t)}});function o(l){l.preventDefault(),l.stopImmediatePropagation();let p=JSON.parse(l.data);p.type==="open"?(p.setCookies.forEach(R=>{__$ampere.scope(document).cookie=R}),Object.defineProperties(t,{protocol:{value:p.protocol},url:{value:r[0]}}),n=1,t.dispatchEvent(new Event("open"))):t.close()}t.addEventListener("message",o,{once:!0});function c(l){l.preventDefault(),l.stopImmediatePropagation(),t.send(JSON.stringify({type:"connect",remote:r[0],protocols:r[1]?[r[1]].flat():[],headers:{"Cache-Control":"no-cache",Connection:"Upgrade",Host:new URL(r[0]).host,Origin:__$ampere.scope(location).origin,Pragma:"no-cache",Upgrade:"websocket","User-Agent":navigator.userAgent,Cookie:__$ampere.scope(document).cookie},forwardHeaders:[]}))}return t.addEventListener("open",c,{once:!0}),t}});window.Request=new Proxy(Request,{construct(e,r){return __$ampere.logger.debug("Hooking Request constructor",r[0]),r[0]&&typeof r[0]=="string"&&(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base)),new Proxy(Reflect.construct(e,r),{get(t,n){return n==="url"?__$ampere.unwriteURL(t[n]):Reflect.get(t,n)}})}});window.Response=new Proxy(Response,{construct(e,r){return new Proxy(Reflect.construct(e,r),{get(t,n){return n==="url"?__$ampere.unwriteURL(t[n]):Reflect.get(t,n)}})}});window.open=new Proxy(window.open,{apply(e,r,t){return t[0]&&(t[0]=__$ampere.rewriteURL(t[0],__$ampere.base)),Reflect.apply(e,r,t)}});document.open=new Proxy(document.open,{apply(e,r,t){return t.length===3?(t[0]=__$ampere.rewriteURL(t[0],__$ampere.base),window.open(...t)):Reflect.apply(e,r,t)}});for(let e of __$ampere.config.plugins)try{e.client&&(__$ampere.logger.info("Loading plugin",e.name),e.client(window),__$ampere.logger.info("Loaded plugin",e.name))}catch(r){__$ampere.logger.error("Failed to load plugin",e.name,r)}function b(e){return!e||!e.startsWith(__$ampere.config.prefix)?e:__$ampere.config.codec.decode(e.slice(__$ampere.config.prefix.length))}function $(e){return Object.setPrototypeOf({length:e.length,item(r){if(r!==void 0)return e[r]??null;throw new TypeError("Failed to execute 'item' on 'DOMStringList': 1 argument required, but only 0 present.")},contains(r){if(r!==void 0)return e.includes(r);throw new TypeError("Failed to execute 'contains' on 'DOMStringList': 1 argument required, but only 0 present.")}},DOMStringList.prototype)}var y=new Map;function a(e){let r=y.get(e);return Object.values(y).includes(e)?e:(r||(r=new Proxy(Object.setPrototypeOf({},Location.prototype),{get(t,n){let s=new URL(e.href);if(e.href==="about:srcdoc"||e.href==="about:blank"?s=new URL(__$ampere.unwriteURL(parent.location.pathname)):e.pathname.startsWith(__$ampere.config.prefix)&&(s=new URL(__$ampere.unwriteURL(e.pathname))),n==="constructor")return e.constructor;if(n===Symbol.toStringTag)return"Location";if(n==="assign")return o=>{e.assign(__$ampere.rewriteURL(o,__$ampere.scope(e)))};if(n==="reload")return()=>{e.reload()};if(n==="replace")return o=>{e.replace(__$ampere.rewriteURL(o,__$ampere.scope(e)))};if(n==="toString")return()=>__$ampere.scope(e).href;if(n==="ancestorOrigins")return $([]);if(typeof s[n]<"u")return s[n]},ownKeys(){return Object.keys(e)},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},set(t,n,s){let o=new URL(__$ampere.unwriteURL(e.pathname));return o[n]?(o[n]=s,e.href=__$ampere.rewriteURL(o.toString(),__$ampere.scope(e)),!0):!1}}),y.set(e,r)),r)}var d=new Map;function g(e){let r=d.get(e);return Object.values(d).includes(e)?e:(r||(r=new Proxy(e,{get(t,n,s){switch(n){case"location":return a(e.location);case"documentURI":return a(e.location).toString();case"baseURI":return __$ampere.base;case"cookie":return"";case"referrer":try{return b(new URL(e.referrer).pathname)}catch{return""}case"URL":return a(e.location).toString();case"domain":return a(e.location).hostname;case"write":return(...c)=>{e.write(__$ampere.rewriteHTML(c.join(""),__$ampere.base))};case"writeln":return(...c)=>{e.write(__$ampere.rewriteHTML(c.join(""),__$ampere.base))};default:let o=e[n];return typeof o=="function"&&o.toString==self.Object.toString?new Proxy(o,{apply(c,l,p){return Reflect.apply(c,e,p)}}):o}},set(t,n,s,o){return n==="cookie"?!0:e[n]=s}}),d.set(e,r)),r)}var L=new Map;function f(e){let r=L.get(e);return r||(r=new Proxy(Object.setPrototypeOf({},Storage.prototype),{get(t,n){let s=Object.fromEntries(Object.entries(e).filter(([o])=>o.endsWith(`@${__$ampere.scope(location).host}`)).map(([o,c])=>[o.slice(0,o.length-__$ampere.scope(location).host.length-1),c]));return n==="getItem"?o=>e.getItem(`${o}@${__$ampere.scope(location).host}`):n==="setItem"?(o,c)=>e.setItem(`${o}@${__$ampere.scope(location).host}`,c):n==="removeItem"?o=>e.removeItem(`${o}@${__$ampere.scope(location).host}`):n==="key"?o=>Object.keys(s)[o]:n==="clear"?()=>{Object.keys(s).forEach(o=>{e.removeItem(`${o}@${__$ampere.scope(location).host}`)})}:s[n]},ownKeys(){return Object.keys(e).filter(t=>t.endsWith(`@${__$ampere.scope(location).host}`)).map(t=>t.slice(0,t.length-__$ampere.scope(location).host.length-1))},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},set(t,n,s){return e.setItem(`${n.toString()}@${__$ampere.scope(location).host}`,s),!0}}),L.set(e,r)),r}window.Function=new Proxy(Function,{apply(e,r,t){return t[t.length-1]&&(t[t.length-1]=__$ampere.rewriteJS(t[t.length-1],__$ampere.base)),Reflect.apply(e,r,t)}});function S(e){new Proxy(e,{apply(r,t,n){return n[0]&&(n[0]=__$ampere.rewriteJS(n[0],__$ampere.base)),Reflect.apply(r,t,n)}})}var h=new Map;function u(e){let r=h.get(e);return Object.values(h).includes(e)?e:(r||(r=new Proxy(e,{get(t,n,s){switch(n){case"location":return a(e.location);case"window":return u(e.window);case"document":return g(e.document);case"self":return u(e.self);case"top":return window(e.top??e.parent);case"parent":return u(e.parent);case"opener":return u(e.opener);case"globalThis":return u(e.globalThis);case"eval":return S(e.eval);case"localStorage":return f(e.localStorage);case"sessionStorage":return f(e.sessionStorage);default:let o=e[n];return typeof o=="function"&&o.toString==self.Object.toString?new Proxy(o,{apply(c,l,p){return Reflect.apply(c,e,p)}}):o}},set(t,n,s,o){return e[n]=s,!0}}),h.set(e,r)),r)}function T(e){if(!e)return e;e.constructor;let r=e[Symbol.toStringTag],t=typeof e=="function"?e.name:void 0;if(!new RegExp(`^function ${r||t}\\(\\)\\s+\\{\\s+\\[native code\\]\\s+\\}$`).test(e.constructor.toString()))return e;switch(r||t){case"Window":return u(e);case"Location":return a(e);case"Storage":return f(e);case"HTMLDocument":return g(e);case"postMessage":break;case"eval":return u(window).eval}return e}Object.defineProperty(Object.prototype,"__$ampere",{value:Object.assign(globalThis.__$ampere||{},{scope:T}),configurable:!1,enumerable:!1});})();
