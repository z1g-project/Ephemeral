"use strict";(()=>{var U=Object.create;var T=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var I=Object.getPrototypeOf,C=Object.prototype.hasOwnProperty;var W=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var F=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of D(t))!C.call(e,i)&&i!==r&&T(e,i,{get:()=>t[i],enumerable:!(n=N(t,i))||n.enumerable});return e};var q=(e,t,r)=>(r=e!=null?U(I(e)):{},F(t||!e||!e.__esModule?T(r,"default",{value:e,enumerable:!0}):r,e));var E=W((Y,g)=>{"use strict";var _={decodeValues:!0,map:!1,silent:!1};function $(e){return typeof e=="string"&&!!e.trim()}function L(e,t){var r=e.split(";").filter($),n=r.shift(),i=V(n),o=i.name,a=i.value;t=t?Object.assign({},_,t):_;try{a=t.decodeValues?decodeURIComponent(a):a}catch(l){console.error("set-cookie-parser encountered an error while decoding a cookie with value '"+a+"'. Set options.decodeValues to false to disable this feature.",l)}var c={name:o,value:a};return r.forEach(function(l){var f=l.split("="),m=f.shift().trimLeft().toLowerCase(),d=f.join("=");m==="expires"?c.expires=new Date(d):m==="max-age"?c.maxAge=parseInt(d,10):m==="secure"?c.secure=!0:m==="httponly"?c.httpOnly=!0:m==="samesite"?c.sameSite=d:c[m]=d}),c}function V(e){var t="",r="",n=e.split("=");return n.length>1?(t=n.shift(),r=n.join("=")):r=e,{name:t,value:r}}function k(e,t){if(t=t?Object.assign({},_,t):_,!e)return t.map?{}:[];if(e.headers)if(typeof e.headers.getSetCookie=="function")e=e.headers.getSetCookie();else if(e.headers["set-cookie"])e=e.headers["set-cookie"];else{var r=e.headers[Object.keys(e.headers).find(function(i){return i.toLowerCase()==="set-cookie"})];!r&&e.headers.cookie&&!t.silent&&console.warn("Warning: set-cookie-parser appears to have been called on a request object. It is designed to parse Set-Cookie headers from responses, not Cookie headers from requests. Set the option {silent: true} to suppress this warning."),e=r}if(Array.isArray(e)||(e=[e]),t=t?Object.assign({},_,t):_,t.map){var n={};return e.filter($).reduce(function(i,o){var a=L(o,t);return i[a.name]=a,i},n)}else return e.filter($).map(function(i){return L(i,t)})}function X(e){if(Array.isArray(e))return e;if(typeof e!="string")return[];var t=[],r=0,n,i,o,a,c;function l(){for(;r<e.length&&/\s/.test(e.charAt(r));)r+=1;return r<e.length}function f(){return i=e.charAt(r),i!=="="&&i!==";"&&i!==","}for(;r<e.length;){for(n=r,c=!1;l();)if(i=e.charAt(r),i===","){for(o=r,r+=1,l(),a=r;r<e.length&&f();)r+=1;r<e.length&&e.charAt(r)==="="?(c=!0,r=a,t.push(e.substring(n,o)),n=r):r=o+1}else r+=1;(!c||r>=e.length)&&t.push(e.substring(n,e.length))}return t}g.exports=k;g.exports.parse=k;g.exports.parseString=L;g.exports.splitCookiesString=X});var B=["getAttribute","setAttribute","hasAttribute","removeAttribute","getAttributeNode","setAttributeNode","removeAttributeNode","getAttributeNames"],J={href:[HTMLAnchorElement,HTMLLinkElement,HTMLAreaElement,HTMLBaseElement],src:[HTMLAudioElement,HTMLEmbedElement,HTMLIFrameElement,HTMLImageElement,HTMLInputElement,HTMLScriptElement,HTMLSourceElement,HTMLTrackElement,HTMLVideoElement],srcdoc:[HTMLIFrameElement],srcset:[HTMLImageElement,HTMLSourceElement],action:[HTMLFormElement],poster:[HTMLVideoElement],formaction:[HTMLButtonElement],data:[HTMLObjectElement],background:[HTMLBodyElement],integrity:[HTMLScriptElement,HTMLLinkElement],nonce:[HTMLElement]},s=Object.fromEntries(B.map(e=>[e,Object.getOwnPropertyDescriptor(Element.prototype,e)?.value])),y=Object.getOwnPropertyDescriptor(Element.prototype,"innerHTML"),w=Object.getOwnPropertyDescriptor(Element.prototype,"innerText");Object.defineProperty(Node.prototype,"baseURI",{get(){return __$ampere.base}});Object.defineProperties(Element.prototype,{innerHTML:{set(e){return this instanceof HTMLScriptElement?y?.set?.call(this,__$ampere.rewriteJS(e,__$ampere.base)):this instanceof HTMLStyleElement?y?.set?.call(this,__$ampere.rewriteCSS(e,__$ampere.base)):y?.set?.call(this,__$ampere.rewriteHTML(e,__$ampere.base,__$ampere.cookie)),e},get(){return y?.get?.call(this)}},innerText:{set:function(e){return this instanceof HTMLScriptElement?w?.set?.call(this,__$ampere.rewriteJS(e,__$ampere.base)):this instanceof HTMLStyleElement?w?.set?.call(this,__$ampere.rewriteCSS(e,__$ampere.base)):w?.set?.call(this,e),e},get:function(){return w?.get?.call(this)}},getAttribute:{value:function(e){return/^_/.test(e)?s.getAttribute.call(this,`_${e}`):s.hasAttribute.call(this,`_${e}`)?s.getAttribute.call(this,`_${e}`):s.getAttribute.call(this,e)}},setAttribute:{value:function(e,t){return e.startsWith("on")?s.setAttribute.call(this,e,__$ampere.rewriteJS(t,__$ampere.base)):/^_/.test(e)?s.setAttribute.call(this,`_${e}`,t):s.setAttribute.call(this,e,t)}},hasAttribute:{value:function(e){return/^_/.test(e)?s.hasAttribute.call(this,`_${e}`):s.hasAttribute.call(this,`_${e}`)?!0:s.hasAttribute.call(this,e)}},removeAttribute:{value:function(e){return/^_/.test(e)?s.removeAttribute.call(this,`_${e}`):s.hasAttribute.call(this,`_${e}`)?s.removeAttribute.call(this,`_${e}`):s.removeAttribute.call(this,e)}},getAttributeNode:{value:function(e){if(/^_/.test(e))return s.getAttributeNode.call(this,`_${e}`);if(s.hasAttribute.call(this,`_${e}`)){let t=s.getAttributeNode.call(this,`_${e}`);return t?new Proxy(t,{get:function(r,n){return["name","localName","nodeName"].includes(n)?r.name.replace(/^_/,""):r[n]}}):null}return s.getAttributeNode.call(this,e)}},setAttributeNode:{value:function(e){return/^on[a-z]+/i.test(e.name)?s.setAttribute.call(this,e.name,__$ampere.rewriteJS(e.value,__$ampere.base)):/^_/.test(e.name)?s.setAttribute.call(this,`_${e}`,e.value):s.setAttributeNode.call(this,e)}},removeAttributeNode:{value:function(e){return/^_/.test(e.name)?s.removeAttribute.call(this,`_${e.name}`):s.hasAttribute.call(this,`_${e.name}`)?(s.removeAttribute.call(this,e.name),s.removeAttribute.call(this,`_${e.name}`)):s.removeAttributeNode.call(this,e)}},getAttributeNames:{value:function(){let e=s.getAttributeNames.call(this);return e=e.map(t=>/^_/.test(t)?t.replace(/^_/,""):t),Array.from(new Set(e))}}});Object.entries(J).forEach(([e,t])=>{t.forEach(r=>{let{get:n,set:i}=Object.getOwnPropertyDescriptor(r.prototype,e)??{};!n||!i||Object.defineProperty(r.prototype,e,{get(){return e==="href"||e==="src"?__$ampere.unwriteURL(this.getAttribute(e)):n.call(this)},set(o){return e==="href"||e==="src"?s.setAttribute.call(this,e,__$ampere.rewriteURL(o,__$ampere.base)):e==="integrity"?s.setAttribute.call(this,`_${e}`,o):e==="srcset"?(s.setAttribute.call(this,"srcset",__$ampere.rewriteSrcSet(o,__$ampere.base)),s.setAttribute.call(this,`_${e}`,o)):e==="srcdoc"?(s.setAttribute.call(this,"srcdoc",__$ampere.rewriteHTML(o,__$ampere.base,__$ampere.cookie)),s.setAttribute.call(this,`_${e}`,o)):i.call(this,o),o}})})});function R(e){return new Proxy(e,{apply(t,r,n){return __$ampere.logger.debug("Hooking history update",n[2]),n[2]&&(n[2]=__$ampere.rewriteURL(n[2],__$ampere.base)),Reflect.apply(t,r,n)}})}history.pushState=R(history.pushState);history.replaceState=R(history.replaceState);Object.defineProperty(navigator,"serviceWorker",{get(){}});Object.defineProperty(Navigator.prototype,"serviceWorker",{get(){}});window.fetch=new Proxy(fetch,{apply(e,t,r){return __$ampere.logger.debug("Hooking fetch",r[0]),r[0]&&typeof r[0]=="string"&&(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base)),Reflect.apply(e,t,r)}});navigator.sendBeacon=new Proxy(navigator.sendBeacon,{apply(e,t,r){return __$ampere.logger.debug("Hooking sendBeacon",r[0]),r[0]&&(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base)),Reflect.apply(e,t,r)}});window.XMLHttpRequest.prototype.open=new Proxy(window.XMLHttpRequest.prototype.open,{apply(e,t,r){return __$ampere.logger.debug("Hooking XHR.open",r[1]),r[1]&&(r[1]=__$ampere.rewriteURL(r[1].toString(),__$ampere.base)),Reflect.apply(e,t,r)}});window.WebSocket=new Proxy(window.WebSocket,{construct(e,t){let r=new e(`${location.protocol.replace("http","ws")}//${new URL(__$ampere.bare).host}/v3/`),n=0,i=Object.getOwnPropertyDescriptor(WebSocket.prototype,"readyState")?.get;Object.defineProperty(r,"readyState",{get(){return n===0?0:i?.call(r)}});function o(c){c.preventDefault(),c.stopImmediatePropagation();let l=JSON.parse(c.data);l.type==="open"?(l.setCookies.forEach(f=>{__$ampere.scope(document).cookie=f}),Object.defineProperties(r,{protocol:{value:l.protocol},url:{value:t[0]}}),n=1,r.dispatchEvent(new Event("open"))):r.close()}r.addEventListener("message",o,{once:!0});function a(c){c.preventDefault(),c.stopImmediatePropagation(),r.send(JSON.stringify({type:"connect",remote:t[0],protocols:t[1]?[t[1]].flat():[],headers:{"Cache-Control":"no-cache",Connection:"Upgrade",Host:new URL(t[0]).host,Origin:__$ampere.scope(location).origin,Pragma:"no-cache",Upgrade:"websocket","User-Agent":navigator.userAgent,Cookie:__$ampere.scope(document).cookie},forwardHeaders:[]}))}return r.addEventListener("open",a,{once:!0}),r}});window.Request=new Proxy(Request,{construct(e,t){return __$ampere.logger.debug("Hooking Request constructor",t[0]),t[0]&&typeof t[0]=="string"&&(t[0]=__$ampere.rewriteURL(t[0],__$ampere.base)),new Proxy(Reflect.construct(e,t),{get(r,n){return n==="url"?__$ampere.unwriteURL(r[n]):Reflect.get(r,n)}})}});window.Response=new Proxy(Response,{construct(e,t){return new Proxy(Reflect.construct(e,t),{get(r,n){return n==="url"?__$ampere.unwriteURL(r[n]):Reflect.get(r,n)}})}});window.open=new Proxy(window.open,{apply(e,t,r){return r[0]&&(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base)),Reflect.apply(e,t,r)}});document.open=new Proxy(document.open,{apply(e,t,r){return r.length===3?(r[0]=__$ampere.rewriteURL(r[0],__$ampere.base),window.open(...r)):Reflect.apply(e,t,r)}});for(let e of __$ampere.config.plugins)try{e.client&&(__$ampere.logger.info("Loading plugin",e.name),e.client(window),__$ampere.logger.info("Loaded plugin",e.name))}catch(t){__$ampere.logger.error("Failed to load plugin",e.name,t)}var P=q(E(),1);function x(e){let t=(0,P.default)(e,{silent:!0,decodeValues:!1})[0];return t.expires&&t.expires.getTime()<Date.now()?(__$ampere.cookie=__$ampere.cookie.replace(`${t.name}=${t.value}`,"").replace(/(;\s*){2,}/g,"; "),e):(__$ampere.cookie=`${__$ampere.cookie}; ${t.name}=${t.value}}`,(async()=>(await __$ampere.setCookie(e,__$ampere.base),__$ampere.cookie=await __$ampere.getCookie(__$ampere.base)??""))(),e)}window.addEventListener("message",e=>{e.data.type==="cookie"&&(__$ampere.cookie=e.data.value)});function O(e){return Object.setPrototypeOf({length:e.length,item(t){if(t!==void 0)return e[t]??null;throw new TypeError("Failed to execute 'item' on 'DOMStringList': 1 argument required, but only 0 present.")},contains(t){if(t!==void 0)return e.includes(t);throw new TypeError("Failed to execute 'contains' on 'DOMStringList': 1 argument required, but only 0 present.")}},DOMStringList.prototype)}var S=new Map;function u(e){let t=S.get(e);return Object.values(S).includes(e)?e:(t||(t=new Proxy(Object.setPrototypeOf({},Location.prototype),{get(r,n){let i=new URL(e.href);if(e.href==="about:srcdoc"||e.href==="about:blank"?i=new URL(__$ampere.unwriteURL(parent.location.pathname)):e.pathname.startsWith(__$ampere.config.prefix)&&(i=new URL(__$ampere.unwriteURL(e.pathname))),n==="constructor")return e.constructor;if(n===Symbol.toStringTag)return"Location";if(n==="assign")return o=>{e.assign(__$ampere.rewriteURL(o,__$ampere.scope(e)))};if(n==="reload")return()=>{e.reload()};if(n==="replace")return o=>{e.replace(__$ampere.rewriteURL(o,__$ampere.scope(e)))};if(n==="toString")return()=>__$ampere.scope(e).href;if(n==="ancestorOrigins")return O([]);if(typeof i[n]<"u")return i[n]},ownKeys(){return Object.keys(e)},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},set(r,n,i){let o=new URL(__$ampere.unwriteURL(e.pathname));return o[n]?(o[n]=i,e.href=__$ampere.rewriteURL(o.toString(),__$ampere.scope(e)),!0):!1}}),S.set(e,t)),t)}var A=new Map;function b(e){let t=A.get(e);return Object.values(A).includes(e)?e:(t||(t=new Proxy(e,{get(r,n,i){switch(n){case"location":return u(e.location);case"documentURI":return u(e.location).toString();case"baseURI":return __$ampere.base;case"cookie":return __$ampere.cookie;case"referrer":try{return __$ampere.unwriteURL(new URL(e.referrer).pathname)}catch{return""}case"URL":return u(e.location).toString();case"domain":return u(e.location).hostname;case"write":return(...a)=>{e.write(__$ampere.rewriteHTML(a.join(""),__$ampere.base,__$ampere.cookie))};case"writeln":return(...a)=>{e.write(__$ampere.rewriteHTML(a.join(""),__$ampere.base,__$ampere.cookie))};default:let o=e[n];return typeof o=="function"&&o.toString==self.Object.toString?new Proxy(o,{apply(a,c,l){return Reflect.apply(a,e,l)}}):o}},set(r,n,i,o){return n==="cookie"?x(i):e[n]=i}}),A.set(e,t)),t)}var M=new Map;function h(e){let t=M.get(e);return t||(t=new Proxy(Object.setPrototypeOf({},Storage.prototype),{get(r,n){let i=Object.fromEntries(Object.entries(e).filter(([o])=>o.endsWith(`@${__$ampere.scope(location).host}`)).map(([o,a])=>[o.slice(0,o.length-__$ampere.scope(location).host.length-1),a]));return n==="getItem"?o=>e.getItem(`${o}@${__$ampere.scope(location).host}`):n==="setItem"?(o,a)=>e.setItem(`${o}@${__$ampere.scope(location).host}`,a):n==="removeItem"?o=>e.removeItem(`${o}@${__$ampere.scope(location).host}`):n==="key"?o=>Object.keys(i)[o]:n==="clear"?()=>{Object.keys(i).forEach(o=>{e.removeItem(`${o}@${__$ampere.scope(location).host}`)})}:i[n]},ownKeys(){return Object.keys(e).filter(r=>r.endsWith(`@${__$ampere.scope(location).host}`)).map(r=>r.slice(0,r.length-__$ampere.scope(location).host.length-1))},getOwnPropertyDescriptor(){return{enumerable:!0,configurable:!0}},set(r,n,i){return e.setItem(`${n.toString()}@${__$ampere.scope(location).host}`,i),!0}}),M.set(e,t)),t}window.Function=new Proxy(Function,{apply(e,t,r){return r[r.length-1]&&(r[r.length-1]=__$ampere.rewriteJS(r[r.length-1],__$ampere.base)),Reflect.apply(e,t,r)}});window.Worker=new Proxy(Worker,{construct(e,t){return t[0]&&(t[0]=__$ampere.rewriteJS(t[0],__$ampere.base)),Reflect.construct(e,t)}});"imoportScripts"in self&&(self.importScripts=new Proxy(self.importScripts,{apply(e,t,r){return r=r.map(n=>__$ampere.rewriteURL(n,__$ampere.base)),Reflect.apply(e,t,r)}}));function H(e){new Proxy(e,{apply(t,r,n){return n[0]&&(n[0]=__$ampere.rewriteJS(n[0],__$ampere.base)),Reflect.apply(t,r,n)}})}var v=new Map;function p(e){let t=v.get(e);return Object.values(v).includes(e)?e:(t||(t=new Proxy(e,{get(r,n,i){switch(n){case"location":return u(e.location);case"window":return p(e.window);case"document":return b(e.document);case"self":return p(e.self);case"top":return window(e.top??e.parent);case"parent":return p(e.parent);case"opener":return p(e.opener);case"globalThis":return p(e.globalThis);case"eval":return H(e.eval);case"localStorage":return h(e.localStorage);case"sessionStorage":return h(e.sessionStorage);default:let o=e[n];return typeof o=="function"&&o.toString==self.Object.toString?new Proxy(o,{apply(a,c,l){return Reflect.apply(a,e,l)}}):o}},set(r,n,i,o){return e[n]=i,!0}}),v.set(e,t)),t)}function j(e){if(!e)return e;e.constructor;let t=e[Symbol.toStringTag],r=typeof e=="function"?e.name:void 0;if(!new RegExp(`^function ${t||r}\\(\\)\\s+\\{\\s+\\[native code\\]\\s+\\}$`).test(e.constructor.toString()))return e;switch(t||r){case"Window":return p(e);case"Location":return u(e);case"Storage":return h(e);case"HTMLDocument":return b(e);case"postMessage":break;case"eval":return p(window).eval}return e}Object.defineProperty(Object.prototype,"__$ampere",{value:Object.assign(globalThis.__$ampere||{},{scope:j}),configurable:!1,enumerable:!1});})();
