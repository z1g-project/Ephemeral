"use strict";(()=>{function h(o,t){return o.set("Origin",new URL(t).origin),o.set("Host",new URL(t).host),o.set("Referer",t.toString()),o}function g(o,t){return o.delete("content-security-policy"),o.delete("content-security-policy-report-only"),o}var u=class{listeners={};on(t,r){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(r)}once(t,r){let a=(...n)=>(this.off(t,a),r(...n));this.on(t,a)}off(t,r){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(a=>a!==r))}async emit(t,...r){let a;if(this.listeners[t]){for(let n of this.listeners[t])a=await n(...r)??a;return a}}};var d=class extends u{ready;constructor(){super();for(let t of __$ampere.config.plugins)try{t.worker&&(__$ampere.logger.info("Loading plugin",t.name),t.worker(this),__$ampere.logger.info("Loaded plugin",t.name))}catch(r){__$ampere.logger.error("Failed to load plugin",t.name,r)}this.ready=Promise.resolve(),self.addEventListener("install",()=>{__$ampere.logger.info("Service Worker installed")})}async makeRequest(t,r){return __$ampere.logger.info("Fetching",t.href),await __$ampere.bareClient.fetch(t,r)}async fetch(t){await this.ready;let{files:r}=__$ampere.config,a=[r.config,r.client,r.worker,r.bundle].map(e=>r.directory+e),n=new URL(t.request.url);if(a.includes(n.pathname))return __$ampere.logger.info("Loading ampere script",n.href),fetch(t.request);let p=__$ampere.unwriteURL(n.pathname)+n.search+n.hash;if(n.search||n.hash)return __$ampere.logger.debug("Detected non-encoded data in URL, redirecting from",n.href,"to",__$ampere.rewriteURL(p,n)),new Response(null,{status:301,headers:{location:__$ampere.rewriteURL(p,n)}});try{new URL(p)}catch{return __$ampere.logger.error("Decoded URL is invalid",p),new Response("Invalid URL",{status:400})}let i=new URL(p),c={method:t.request.method,headers:Object.fromEntries(t.request.headers),redirect:"manual",duplex:"half"};["GET","HEAD"].includes(t.request.method)||(c.body=t.request.body);let f=new Request(i,c),_=h(new Headers(c.headers),i);Object.defineProperty(f,"headers",{get(){return _}}),f=await this.emit("request",f)??f;let s=await this.makeRequest(i,c);if(s.status>=300&&s.status<400&&s.headers.has("location"))return __$ampere.logger.debug("Redirecting from",i.href,"to",s.headers.get("location")),new Response(null,{status:301,headers:{location:__$ampere.rewriteURL(s.headers.get("location"),i)}});let w={status:s.status,statusText:s.statusText,headers:g(s.headers,i)},l;if([101,204,205,304].includes(s.status))l=null,__$ampere.logger.info("Returning empty response for",i.href);else if(s.headers.get("content-type")?.includes("text/html")){__$ampere.logger.info("Rewriting HTML for",i.href);let e=await s.text();e=await this.emit("html",e)??e,e=await this.emit("pre:html",e)??e,e=__$ampere.rewriteHTML(e,i),l=await this.emit("post:html",e)??e}else if(s.headers.get("content-type")?.includes("application/javascript")||["script","sharedworker","worker"].includes(t.request.destination)){__$ampere.logger.info("Rewriting JS for",i.href);let e=await s.text();e=await this.emit("js",e)??e,e=await this.emit("pre:js",e)??e,e=__$ampere.rewriteJS(e,i),l=await this.emit("post:js",e)??e}else if(s.headers.get("content-type")?.includes("text/css")||["style"].includes(t.request.destination)){__$ampere.logger.info("Rewriting CSS for",i.href);let e=await s.text();e=await this.emit("css",e)??e,e=await this.emit("pre:css",e)??e,e=__$ampere.rewriteCSS(e,i),l=await this.emit("post:css",e)??e}else if(t.request.destination==="manifest"){__$ampere.logger.info("Rewriting Manifest for",i.href);let e=await s.text();e=await this.emit("manifest",e)??e,e=await this.emit("pre:manifest",e)??e,e=__$ampere.rewriteManifest(e,i),l=await this.emit("post:manifest",e)??e}else __$ampere.logger.info("Returning binary for",i.href),l=s.body;let m=new Response(l,w);return m=await this.emit("response",m)??m,m}};self.AmpereWorker=d;})();
